#!/bin/bash
# Pre-commit hook: PHI and credential protection
# Enforces Prime Directive #0 â€” blocks commits containing PHI or secrets
#
# Checks staged files (not working tree) for:
#   1. Patterns that suggest patient health information (PHI)
#   2. Credential/key file patterns
#   3. Known dangerous file types that should never be committed

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

BLOCKED=0

# --- Check 1: Dangerous file extensions/names in staged files ---
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# File patterns that should never be committed
DANGEROUS_FILE_PATTERNS=(
    '\.dcm$'
    '\.DCM$'
    '\.nii$'
    '\.nii\.gz$'
    'proknow.*\.json'
    'credential.*\.json'
    'private.?key'
    '\.pem$'
    '\.secret$'
    'api.?key'
    '\.env$'
)

for pattern in "${DANGEROUS_FILE_PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | grep -iE "$pattern" || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}BLOCKED: Staged file matches dangerous pattern '${pattern}':${NC}"
        echo "$MATCHES" | while read -r f; do echo "  $f"; done
        BLOCKED=1
    fi
done

# --- Check 2: PHI patterns in staged file contents ---
# Exclude this hook script itself and install script to avoid self-matching on pattern strings
CONTENT_DIFF=$(git diff --cached -U0 --diff-filter=ACM -- . ':!scripts/hooks/pre-commit' ':!scripts/install-hooks.sh' 2>/dev/null || true)

PHI_PATTERNS=(
    'MRN[[:space:]]*[:=][[:space:]]*[0-9]'
    'medical.record.number'
    'patient.?name[[:space:]]*[:=]'
    'date.?of.?birth[[:space:]]*[:=]'
    'DOB[[:space:]]*[:=][[:space:]]*[0-9]'
    'SSN[[:space:]]*[:=]'
    'social.security'
)

for pattern in "${PHI_PATTERNS[@]}"; do
    MATCHES=$(echo "$CONTENT_DIFF" | grep -iE "^\+.*${pattern}" | head -5 || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}BLOCKED: Staged content matches PHI pattern '${pattern}':${NC}"
        echo "$MATCHES" | while read -r line; do echo "  $line"; done
        BLOCKED=1
    fi
done

# --- Check 3: Credential/key patterns in staged content ---
SECRET_PATTERNS=(
    'private.?key.*BEGIN'
    'AKIA[0-9A-Z]{16}'            # AWS access key
    'sk-[a-zA-Z0-9]{20,}'         # OpenAI/Anthropic-style API key
    'ghp_[a-zA-Z0-9]{36}'         # GitHub personal access token
    '"private_key"[[:space:]]*:'   # JSON private key field
    'proknow.*api.*key'
)

for pattern in "${SECRET_PATTERNS[@]}"; do
    MATCHES=$(echo "$CONTENT_DIFF" | grep -iE "^\+.*${pattern}" | head -5 || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}BLOCKED: Staged content matches credential pattern '${pattern}':${NC}"
        echo "$MATCHES" | while read -r line; do echo "  $line"; done
        BLOCKED=1
    fi
done

# --- Check 4: Large binary files that might be medical imaging ---
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(stat --printf="%s" "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
        # Flag files > 50MB (likely medical imaging or model weights)
        if [ "$SIZE" -gt 52428800 ]; then
            echo -e "${YELLOW}WARNING: Large file staged ($(( SIZE / 1048576 )) MB): ${file}${NC}"
            echo "  If this is medical imaging data or a model checkpoint, remove it."
            BLOCKED=1
        fi
    fi
done

if [ "$BLOCKED" -eq 1 ]; then
    echo ""
    echo -e "${RED}=== COMMIT BLOCKED ===${NC}"
    echo -e "${RED}Prime Directive #0: PHI and credentials must NEVER be committed.${NC}"
    echo ""
    echo "To fix: unstage the flagged files with 'git reset HEAD <file>'"
    echo "If this is a false positive, use 'git commit --no-verify' (use with extreme caution)."
    exit 1
fi

exit 0
